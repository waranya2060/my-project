{% extends 'base3.html' %}
{% block title %}‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£{% endblock %}
{% block content %}
<div class="wrapper p-8 bg-gray-50">
    <section class="overview-container">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ 2 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á -->
            <div class="hidden md:block md:col-span-3"></div>
            
            <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡∏á -->
            <div class="bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 text-center flex flex-col justify-between h-[320px] md:col-span-3">
                <div class="text-center">
                    <div class="bg-blue-100 h-12 w-12 flex items-center justify-center rounded-full mx-auto mb-1">
                        <i class="fas fa-users text-blue-600"></i>
                    </div>
                    <h3 class="text-base font-semibold mt-1 text-gray-700">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <h1 class="text-2xl font-bold text-gray-900 mt-1">{{ total_users }}</h1>
                </div>
                <canvas id="userChart" class="mt-2 max-h-28"></canvas>
                <div class="legend flex justify-center mt-2 text-xs text-gray-600">
                    <span class="legend-item mr-3 flex items-center">
                        <span class="w-2 h-2 bg-red-500 inline-block mr-1 rounded-full"></span> ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                    </span>
                    <span class="legend-item flex items-center">
                        <span class="w-2 h-2 bg-yellow-500 inline-block mr-1 rounded-full"></span> ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå
                    </span>
                </div>
            </div>
        
            <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡∏á -->
            <div class="bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 text-center flex flex-col justify-center h-[320px] md:col-span-3">
                <div class="text-center">
                    <div class="bg-green-100 h-12 w-12 flex items-center justify-center rounded-full mx-auto mb-1">
                        <i class="fas fa-calendar-check text-green-600"></i>
                    </div>
                    <h3 class="text-base font-semibold mt-1 text-gray-700">‡∏ô‡∏±‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <h1 class="text-2xl font-bold text-gray-900 mt-1">{{ total_appointments }}</h1>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-3">
                    <div class="p-1 bg-green-50 rounded-md">
                        <p class="text-xs text-gray-600">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                        <p class="text-base font-bold text-green-600">{{ confirmed_appointments|default:"0" }}</p>
                    </div>
                    <div class="p-1 bg-yellow-50 rounded-md">
                        <p class="text-xs text-gray-600">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
                        <p class="text-base font-bold text-yellow-600">{{ pending_appointments|default:"0" }}</p>
                    </div>
                    <div class="p-1 bg-red-50 rounded-md">
                        <p class="text-xs text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</p>
                        <p class="text-base font-bold text-red-600">{{ cancelled_appointments|default:"0" }}</p>
                    </div>
                </div>
            </div>
            
            <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ 2 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á -->
            <div class="hidden md:block md:col-span-3"></div>
        
            <!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ - ‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡∏ç‡πà -->
            <div class="bg-white p-3 md:p-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 flex flex-col h-[500px] md:col-span-12">
                <h2 class="text-base font-bold mb-3 text-center text-gray-700 flex items-center justify-center">
                    <i class="fas fa-calendar-alt text-blue-500 mr-1"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
                </h2>
                <div id="calendar" class="flex-grow w-full overflow-hidden"></div>
            </div>
        </div>
    </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var totalStudents = Number("{{ total_students|default:0 }}".trim());
        var totalTeachers = Number("{{ total_teachers|default:0 }}".trim());
    
        if (isNaN(totalStudents) || isNaN(totalTeachers)) {
            console.error("üö® ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Django ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            return;
        }
    
        if (totalStudents === 0 && totalTeachers === 0) {
            console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ! ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á");
            return;
        }
    
        var ctx = document.getElementById("userChart").getContext("2d");
        var userChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå"],
                datasets: [{
                    data: [totalStudents, totalTeachers],
                    backgroundColor: ["#F87171", "#FBBF24"],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: false,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    }
                },
                cutout: '65%'
            }
        });
        var calendarEl = document.getElementById("calendar");
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            locale: 'th',
            headerToolbar: {
                left: "prev,next today",
                center: "title",
                right: "dayGridMonth,timeGridWeek"
            },
            buttonText: {
                today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå'
            },
            themeSystem: 'bootstrap5',
            height: '100%',
            eventSources: [
            {
                events: [
            {% for appointment in appointments %}
            {
                id: '{{ appointment.id }}',
                title: '{{ appointment.project.topic|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" }}',
                start: '{{ appointment.date|date:"Y-m-d" }}T{{ appointment.time_start|time:"H:i:s" }}',
                end: '{{ appointment.date|date:"Y-m-d" }}T{{ appointment.time_finish|time:"H:i:s" }}',
                backgroundColor: '#10B981',  // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                textColor: 'white',
                borderColor: 'transparent',
                extendedProps: {
                    location: '{{ appointment.location|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}',
                    advisor: '{% if appointment.project.advisor %}{{ appointment.project.advisor.get_full_name|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}{% else %}‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏{% endif %}',
                    status: '{{ appointment.status|default:"pending" }}'
                }
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
                ]
            }
        ],
            eventClick: function(info) {
                var event = info.event;
                var start = event.start ? event.start.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';
                var end = event.end ? event.end.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';
                var status = event.extendedProps.status === 'accepted' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : 
                            event.extendedProps.status === 'pending' ? '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                alert(
                    "üìÖ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: " + event.title + "\n" +
                    "‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: " + start + (end ? " - " + end : "") + "\n" +
                    "üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: " + event.extendedProps.location + "\n" +
                    "üë®‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤: " + event.extendedProps.advisor + "\n" +
                    "üîÑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: " + status
                );
            },
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            dayMaxEvents: 2,
            eventDisplay: 'block',
            eventBorderRadius: 4
        });
        
        calendar.render();
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        console.log("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô:", calendar.getEvents().length);
    });
</script>
{% endblock %}