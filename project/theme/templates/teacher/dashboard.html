{% extends 'base.html' %}
{% block title %}ปฏิทินกิจกรรม{% endblock %}
{% block content %}
<div class="container mx-auto mt-8 px-4 max-w-7xl">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-800">ปฏิทินกิจกรรม</h2>
        {% if user.is_teacher or user.is_manager %}
        <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">อาจารย์</span>
        {% endif %}
    </div>
    
   <div class="bg-white rounded-xl shadow-md p-5 mb-6 border border-gray-100">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
            <div class="bg-blue-50 p-3 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <div>
                <h3 class="font-semibold text-gray-800 text-base">เชื่อมต่อปฏิทิน</h3>
                <p class="text-sm text-gray-500">เพิ่มการนัดหมายเข้าปฏิทิน Google ของคุณ</p>
            </div>
        </div>
       {% if has_google_token %}
    <span class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 text-sm font-medium rounded-lg shadow-sm">
        <i class="fas fa-check-circle mr-2 text-green-500"></i>
        เชื่อมต่อแล้ว
    </span>
{% else %}
    <a href="{% url 'connect_google_calendar' %}" 
       class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 text-sm shadow">
        <i class="fas fa-plus mr-2"></i>
        เชื่อมต่อกับ Google Calendar
    </a>
{% endif %}
    </div>
</div>
    
    <!-- ปฏิทิน -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 overflow-hidden">
        <div id="calendar" class="w-full h-[700px] rounded-lg"></div>
    </div>
    
    <!-- ส่วนคำอธิบายสี -->
    <div class="mt-6 bg-white rounded-xl shadow-md p-5 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">สัญลักษณ์และความหมาย</h3>
        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
            <div class="w-5 h-5 rounded-full mr-3 bg-green-500"></div>
            <span class="text-sm text-gray-700">การนัดหมายที่ยืนยันแล้ว</span>
        </div>
    </div>
</div>

<!-- Modal สำหรับแสดงรายละเอียดการนัดหมาย -->
<div id="appointmentModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        
        <!-- Modal centering -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-12 sm:w-12">
                        <svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                        <div class="mt-4 space-y-3">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium text-gray-900 block mb-1">วันที่และเวลา</span>
                                    <span id="modal-time" class="text-gray-600"></span>
                                </p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium text-gray-900 block mb-1">สถานที่</span>
                                    <span id="modal-location" class="text-gray-600"></span>
                                </p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium text-gray-900 block mb-1">อาจารย์ที่ปรึกษา</span>
                                    <span id="modal-advisor" class="text-gray-600"></span>
                                </p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium text-gray-900 block mb-1">คณะกรรมการ</span>
                                    <span id="modal-committee" class="text-gray-600"></span>
                                </p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium text-gray-900 block mb-1">นักศึกษา</span>
                                    <span id="modal-students" class="text-gray-600"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <a href="#" id="meetingLink" target="_blank" class="w-full justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors duration-200 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    เข้าร่วมประชุม
                </a>
                <button type="button" id="closeModal" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition-colors duration-200">
                    ปิด
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript สำหรับปฏิทิน -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const modal = document.getElementById('appointmentModal');
    const closeModalBtn = document.getElementById('closeModal');

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'th',
        height: 'auto',
        themeSystem: 'standard',
        dayMaxEvents: true, // เมื่อกิจกรรมมากเกินไปจะแสดงลิงก์ "+เพิ่มเติม"
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: 'วันนี้',
            month: 'เดือน',
            week: 'สัปดาห์',
            day: 'วัน'
        },
        titleFormat: { 
            year: 'numeric', 
            month: 'long'
        },
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            meridiem: false,
            hour12: false
        },
        events: [
            {% for appointment in confirmed_appointments %}
            {
                id: '{{ appointment.id }}',
                title: '{{ appointment.project.topic }}',
                start: '{{ appointment.date|date:"Y-m-d" }}T{{ appointment.time_start|time:"H:i:s" }}',
                end: '{{ appointment.date|date:"Y-m-d" }}T{{ appointment.time_finish|time:"H:i:s" }}',
                extendedProps: {
                    location: {% if appointment.meeting_link %}"ออนไลน์"{% else %}{{ appointment.location|default:"ไม่ระบุ"|safe|escapejs }}{% endif %},
                    advisor: '{{ appointment.project.advisor.get_full_name }}',
                    meetingLink: '{{ appointment.meeting_link|default:"#" }}',
                    committee: [{% for teacher in appointment.project.committee.all %}'{{ teacher.get_full_name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                    students: [{% for student in appointment.project.students.all %}'{{ student.get_full_name }}'{% if not forloop.last %},{% endif %}{% endfor %}]
                },
                color: '#10B981',
                borderColor: '#059669',
                textColor: '#ffffff',
                classNames: ['rounded-md', 'px-2', 'py-1'],
            },
            {% endfor %}
        ],
   eventClick: function(info) {
    const event = info.event;

    document.getElementById('modal-title').textContent = event.title;
    document.getElementById('modal-time').textContent = `${event.start.toLocaleString('th-TH', { dateStyle: 'full' })} ${event.start.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} - ${event.end.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}`;

    const location = event.extendedProps.location;
    let locationText = "ไม่ระบุ";
    if (location && location.startsWith("http")) {
        locationText = "ออนไลน์";
    } else if (location && location.trim() !== "") {
        locationText = location;
    }
    document.getElementById('modal-location').textContent = locationText;
    document.getElementById('modal-advisor').textContent = event.extendedProps.advisor;
    document.getElementById('modal-committee').textContent = event.extendedProps.committee.join(', ');
    document.getElementById('modal-students').textContent = event.extendedProps.students.join(', ');

    const meetingLink = document.getElementById('meetingLink');
    if (event.extendedProps.meetingLink && event.extendedProps.meetingLink !== '#') {
        meetingLink.href = event.extendedProps.meetingLink;
        meetingLink.classList.remove('hidden');
    } else {
        meetingLink.classList.add('hidden');
    }

    const modal = document.getElementById('appointmentModal');
    modal.classList.remove('hidden');

    // ✅ เพิ่มการปิด Modal ตรงนี้
    const closeModalBtn = document.getElementById('closeModal');
    if (closeModalBtn) {
        closeModalBtn.onclick = () => modal.classList.add('hidden');
    }

    modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('bg-gray-500') || e.target === modal) {
            modal.classList.add('hidden');
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
        }
    });
},
        eventDidMount: function(info) {
            // เพิ่ม tooltip
            tippy(info.el, {
                content: `${info.event.title}<br>${info.event.start.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} - ${info.event.end.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}`,
                allowHTML: true,
                placement: 'top',
                arrow: true,
                theme: 'light'
            });
        }
    });
    
    calendar.render();

    // สร้างเอฟเฟกต์เวลากดปุ่มมุมมอง
    const viewButtons = [
        document.getElementById('month-view'),
        document.getElementById('week-view'),
        document.getElementById('day-view')
    ];
    
    // ปุ่มควบคุมมุมมอง
    document.getElementById('today-button').addEventListener('click', () => {
        calendar.today();
        animateButton(document.getElementById('today-button'));
    });
    
    document.getElementById('month-view').addEventListener('click', () => {
        calendar.changeView('dayGridMonth');
        setActiveViewButton('month-view');
    });
    
    document.getElementById('week-view').addEventListener('click', () => {
        calendar.changeView('timeGridWeek');
        setActiveViewButton('week-view');
    });
    
    document.getElementById('day-view').addEventListener('click', () => {
        calendar.changeView('timeGridDay');
        setActiveViewButton('day-view');
    });
    
    // ฟังก์ชันสำหรับเปลี่ยนสถานะปุ่มที่เลือก
    function setActiveViewButton(activeId) {
        viewButtons.forEach(button => {
            if (button.id === activeId) {
                button.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-300');
                button.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                animateButton(button);
            } else {
                button.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-300');
                button.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            }
        });
    }
    
    // ฟังก์ชันสำหรับสร้างเอฟเฟกต์เมื่อกดปุ่ม
    function animateButton(button) {
        button.classList.add('scale-95');
        setTimeout(() => {
            button.classList.remove('scale-95');
        }, 150);
    }
    
    // ตั้งค่าเริ่มต้น
    setActiveViewButton('month-view');
 });

</script>

<!-- Tooltip Library -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
{% endblock %}