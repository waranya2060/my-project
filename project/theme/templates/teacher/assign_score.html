{% extends 'base.html' %} 
{% block title %}ให้คะแนนโครงงาน{% endblock %}
{% block content %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }
    
    .score-form {
        display: none;
    }
</style>

<div class="container mx-auto mt-8 px-4 max-w-4xl fade-in">
    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800 border-b pb-3">ให้คะแนนโครงงาน</h2>
    
    <!-- แสดงรายการโปรเจคทั้งหมด -->
    <div class="mt-4 space-y-6">
        {% for project in projects %}
        <div class="p-5 bg-white shadow-lg rounded-lg border border-gray-100 hover:shadow-xl transition-shadow duration-300">
            <!-- หัวข้อโปรเจค -->
            <div class="mb-4">
                <h3 class="text-xl font-semibold text-gray-800">{{ project.topic }}</h3>
                <p class="text-gray-600">ปีการศึกษา: {{ project.year }}</p>
            </div>
            
            <!-- รายละเอียดโปรเจค -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-gray-50 p-3 rounded-lg">
                <!-- ข้อมูลนักศึกษา -->
                <div>
                    <h4 class="text-md font-medium text-gray-700 mb-2">นักศึกษา</h4>
                    <ul class="pl-6 space-y-1">
                        {% for student in project.students.all %}
                        <li class="text-gray-600 text-sm">
                            <span class="font-medium">{{ student.student_id }}</span> - {{ student.get_full_name }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- ข้อมูลอาจารย์ -->
                <div>
                    <h4 class="text-md font-medium text-gray-700 mb-2">อาจารย์</h4>
                    <div class="pl-6">
                        <p class="text-gray-600 text-sm">
                            <span class="font-medium">ที่ปรึกษา:</span> {{ project.advisor.get_full_name }}
                        </p>
                        {% if project.committee.all %}
                        <p class="text-gray-600 text-sm mt-1">
                            <span class="font-medium">กรรมการ:</span> 
                            {% for committee in project.committee.all %}
                                {{ committee.get_full_name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- ปุ่มแสดงฟอร์มให้คะแนน -->
            <div class="mt-4 text-center">
                <button type="button" onclick="toggleScoreForm('form-{{ project.id }}')" 
                        class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-4 rounded-md hover:from-blue-600 hover:to-blue-700 transition-colors duration-200 shadow-md">
                    ให้คะแนนโครงงาน
                </button>
            </div>
            
            <!-- ฟอร์มให้คะแนน (ซ่อนไว้) -->
            <form id="form-{{ project.id }}" method="POST" action="{% url 'assign_score' %}" 
                  class="score-form mt-4 bg-gradient-to-r from-blue-50 to-white p-4 rounded-lg border border-blue-100">
                {% csrf_token %}
                <input type="hidden" name="project" value="{{ project.id }}">
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-1">เลือกนักศึกษา:</label>
                    <select name="student" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">-- เลือกนักศึกษา --</option>
                        {% for student in project.students.all %}
                        <option value="{{ student.id }}">{{ student.student_id }} - {{ student.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-1">คะแนน (0-100):</label>
                    <input type="number" name="score" min="0" max="100" 
                        class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <!-- ✅ เพิ่มตรงนี้ -->
<div class="mb-4">
    <label class="block text-gray-700 font-medium mb-1">เกรด:</label>
    <select name="grade" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
        <option value="">-- เลือกเกรด --</option>
        <option value="A">A</option>
        <option value="B+">B+</option>
        <option value="B">B</option>
        <option value="C+">C+</option>
        <option value="C">C</option>
        <option value="D+">D+</option>
        <option value="D">D</option>
        <option value="F">F</option>
    </select>
</div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-1">ความคิดเห็น:</label>
                    <textarea name="comment" rows="3" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                
                <div class="flex justify-between">
                    <button type="submit" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-md hover:from-green-600 hover:to-green-700 transition-colors duration-200 shadow-md">
                        บันทึกคะแนน
                    </button>
                    
                    <button type="button" onclick="toggleScoreForm('form-{{ project.id }}')" 
                            class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition-colors duration-200 shadow-md">
                        ยกเลิก
                    </button>
                </div>
            </form>
        </div>
        {% empty %}
        <div class="text-center p-8 bg-gray-50 rounded-lg border border-gray-200 shadow">
            <p class="text-lg text-gray-600">คุณยังไม่มีโปรเจคที่ต้องให้คะแนน</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // ฟังก์ชันสำหรับแสดง/ซ่อนฟอร์มให้คะแนน
    function toggleScoreForm(formId) {
        const form = document.getElementById(formId);
        if (form.style.display === 'block') {
            form.style.display = 'none';
        } else {
            // ซ่อนฟอร์มทั้งหมดก่อน แล้วจึงแสดงฟอร์มที่ต้องการ
            document.querySelectorAll('.score-form').forEach(form => {
                form.style.display = 'none';
            });
            form.style.display = 'block';
        }
    }

    // ตรวจสอบข้อความจาก Django messages
    document.addEventListener('DOMContentLoaded', function() {
        // ถ้ามีข้อความ success ที่บอกว่าบันทึกคะแนนสำเร็จ ให้ซ่อนฟอร์มทั้งหมด
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'success' and 'บันทึกคะแนนเรียบร้อย' in message.message %}
                    document.querySelectorAll('.score-form').forEach(form => {
                        form.style.display = 'none';
                    });
                {% endif %}
            {% endfor %}
        {% endif %}
    });
</script>
{% endblock %}